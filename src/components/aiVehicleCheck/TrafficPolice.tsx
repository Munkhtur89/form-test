"use client";
import React, { useState, useEffect } from "react";
import { Upload } from "lucide-react";
import { PolicePhotoValidation, UploadedFile } from "@/types/police";
import FileUploadGrid from "../ui/FileUploadGrid";
import ActionButtons from "../ui/ActionButtons";
import { ShowAIToast } from "../vehicle-insurance/ShowAIToast";

interface ContractProps {
  onImageSelected?: (files: File[]) => void;
  onDataExtracted?: (data: PolicePhotoValidation["extractedData"]) => void;
  multiple?: boolean;
  uploadedFiles?: UploadedFile[];
  setUploadedFiles?: React.Dispatch<React.SetStateAction<UploadedFile[]>>;
}

export default function TrafficPolice({
  onImageSelected,
  onDataExtracted,
  multiple = true,
  uploadedFiles: externalUploadedFiles = [],
  setUploadedFiles: externalSetUploadedFiles,
}: ContractProps) {
  // Хэрэв гаднаас uploadedFiles ирээгүй бол дотоод state ашиглана
  const [internalUploadedFiles, setInternalUploadedFiles] = useState<
    UploadedFile[]
  >([]);

  // Гаднаас ирсэн эсвэл дотоод state ашиглах
  const uploadedFiles =
    externalUploadedFiles.length > 0
      ? externalUploadedFiles
      : internalUploadedFiles;
  const setUploadedFiles = externalSetUploadedFiles || setInternalUploadedFiles;

  const [isProcessing, setIsProcessing] = useState(false);

  const [toast, setToast] = useState<{
    message: string;
    isSuccess: boolean;
  } | null>(null);

  // Caching систем нэмэх
  const [processedFiles, setProcessedFiles] = useState<
    Map<string, PolicePhotoValidation>
  >(new Map());

  // Debouncing функц нэмэх
  const [debounceTimer, setDebounceTimer] = useState<NodeJS.Timeout | null>(
    null
  );

  // Toast автоматаар 3 секундийн дараа алга болгох
  useEffect(() => {
    if (toast) {
      const timer = setTimeout(() => setToast(null), 3000);
      return () => clearTimeout(timer);
    }
  }, [toast]);

  // Clean up preview URLs
  useEffect(() => {
    return () => {
      if (uploadedFiles) {
        uploadedFiles.forEach((uploadedFile) => {
          URL.revokeObjectURL(uploadedFile.preview);
        });
      }
      // Debounce timer цэвэрлэх
      if (debounceTimer) {
        clearTimeout(debounceTimer);
      }
    };
  }, [uploadedFiles, debounceTimer]);

  // Зургийг resize хийх функц - хурдны сайжруулалт
  const resizeImage = (
    file: File,
    maxWidth: number = 256, // 512-оос 256 болгож бууруулсан
    maxHeight: number = 256, // 512-оос 256 болгож бууруулсан
    quality: number = 0.6 // 0.8-аас 0.6 болгож бууруулсан
  ): Promise<string> => {
    return new Promise((resolve, reject) => {
      const img = new Image();
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      img.onload = () => {
        let { width, height } = img;

        // Хэмжээг тохируулах
        if (width > height) {
          if (width > maxWidth) {
            height = (height * maxWidth) / width;
            width = maxWidth;
          }
        } else {
          if (height > maxHeight) {
            width = (width * maxHeight) / height;
            height = maxHeight;
          }
        }

        // Canvas хэмжээг тохируулах
        canvas.width = width;
        canvas.height = height;

        // Зургийг canvas дээр зурах
        ctx?.drawImage(img, 0, 0, width, height);

        // Base64 болгон хөрвүүлэх
        const resizedBase64 = canvas.toDataURL("image/jpeg", quality);
        const base64Data = resizedBase64.split(",")[1];
        resolve(base64Data);
      };

      img.onerror = () => {
        reject(new Error("Зураг уншихад алдаа гарлаа"));
      };

      img.src = URL.createObjectURL(file);
    });
  };

  // Файлын hash үүсгэх
  const getFileHash = (file: File): string => {
    return `${file.name}-${file.size}-${file.lastModified}`;
  };

  // Цагдааны зураг AI-р таних функц - хурдны сайжруулалт
  const validateEmergencyDocument = async (
    file: File
  ): Promise<PolicePhotoValidation> => {
    try {
      // Cache шалгах
      const fileHash = getFileHash(file);
      if (processedFiles.has(fileHash)) {
        return processedFiles.get(fileHash)!;
      }

      // Зургийг resize хийж base64 болгон хөрвүүлэх
      const base64 = await resizeImage(file);
      const base64Url = `data:image/jpeg;base64,${base64}`;

      const apiRequestBody = {
        model: "gpt-4o", // gpt-4o-оос gpt-4o-mini болгож хурдны сайжруулалт
        messages: [
          {
            role: "system",
            content: `Та Монгол улсын замын цагдаагийн хэлтсийн ослын бичиг баримтуудыг таних мэргэжлийн AI юм. 

**ЧУУЛГА: Эдгээр бичиг баримтууд нь өөр өөр ослын талаарх мэдээлэл агуулж байна. Тиймээс:**

1. **Эхлээд бичиг баримтын төрлийг тодорхойл** (ЖОЛООЧИЙН МЭДЭЭЛЭЛ, ОСЛЫН СХЕМ, ОСЛЫН АКТ, ОСЛЫН ДҮГНЭЛТ)
2. **Дараа нь тухайн ослын мэдээллийг таних** (огноо, газар, жолоочийн нэр, тээврийн хэрэгслүүд)
3. **Хэрэв ижил төрлийн бичиг баримт байвал тэдгээрийг ялгаж таних**

**БИЧИГ БАРИМТЫН ТӨРЛҮҮД:**

1. **ЖОЛООЧИЙН МЭДЭЭЛЭЛ** (Холбогдогч жолоочийн биеийн байцаалт):
   - Овог нэр, регистрийн дугаар, хүйс
   - Боловсрол, мэргэжил, эрхэлсэн ажил
   - Жолоочийн үнэмлэхний дугаар, хүчинтэй эсэх
   - Жолооч болсон он, курс
   - Үндсэн захиргаа, одоогийн хаяг
   - Биеийн байдал, ажилласан цаг

2. **ОСЛЫН СХЕМ** (Хэмжилтийн бүдүүвч):
   - Осол гарсан газар, огноо, цаг
   - Тээврийн хэрэгслүүдийн байрлал, хэмжээ
   - Замын нөхцөл, чиглэл
   - Хэмжилтийн тооцоо

3. **ОСЛЫН АКТ** (Тээврийн хэрэгслийн мэдээлэл):
   - Марк, улсын дугаар, эзэмшигч
   - Техникийн байдал, хурд
   - Эвдрэлийн тодорхойлолт
   - Гэрч, жолоочийн мэдээлэл

4. **ОСЛЫН ДҮГНЭЛТ** (Замын нөхцөл, зөрчлүүд):
   - Замын гадарга, нөхцөл, топографи
   - Харагдах байдал, цаг агаарын нөхцөл
   - Замын тэмдэг, хязгаарлалт
   - Зөрчсөн дүрмүүд, хариуцлага

**ЖИШЭЭ МЭДЭЭЛҮҮД (өөр өөр ослуудаас):**

**ОСЛЫН ДҮГНЭЛТ 1** (2025.02.19):
   - Осол гарсан газар: Хан-Уул дүүрэг, 20-р хороо, Арслан цагаан хаалга
   - Жолоочийн мэдээл: С. Баярзул, Mercedes-Benz 62-24 UEN
   - Зөрчсөн дүрмүүд: 1.3, 12.3, 11.14

**ОСЛЫН ДҮГНЭЛТ 2** (2025.05.27):
   - Осол гарсан газар: Хан-Уул дүүрэг, 05-р хороо, Наадамчдын гудамж
   - Жолоочийн мэдээл: Дунай Тэрбиш, Toyota Land Cruiser-300, 61-18 УНМ
   - Зөрчсөн дүрмүүд: 15.7, 1.3

**ОСЛЫН АКТ 1** (2025.02.12):
   - Хэргийн дугаар: 0005709, 25-5378, 75
   - Тээврийн хэрэгслүүд: M/BENZ, T. Prices, T.PRIUS

**ОСЛЫН АКТ 2** (2025.05.28):
   - Хэргийн дугаар: 180
   - Тээврийн хэрэгслүүд: Toyota Land Cruiser-300, Toyota Ist

**ЖОЛООЧИЙН МЭДЭЭЛЭЛ** (2025.05.27):
   - Жолоочийн нэр: Дунай Тэрбиш, Сосорбарам Нарантуяа
   - Регистрийн дугаар: ПЮ:76052413, УС:71052004

**ОСЛЫН СХЕМ** (2025.05.28):
   - Бүртгэлийн дугаар: 160
   - Бүдүүвчийг үйлдсэн: Б.Жанчивдорж

**ШИНЭ ОСЛЫН АКТ** (2025.06.14):
   - Хэргийн дугаар: 207.71, ЗХБ-21 ЦБҮАЖ
   - Осол гарсан огноо: 2025.06.14 09:30
   - Осол гарсан газар: Хан-Уул дүүрэг, 2-р хороо, Дунд голын зам
   - Тээврийн хэрэгслүүд: Toyota Crown (1491 УКС), Toyota Harrier (6338 УНЭ)
   - Эзэмшигч: Нэткапитал финанс ббсб, Хувийн
   - Хурд: 5 км/цаг, 40-50 км/цаг
   - Эвдрэлийн тодорхойлолт: Урд буфер, баруун урд гэрэл, баруун крилон, зүүн урд хойд хаалга

**ШИНЭ ОСЛЫН ДҮГНЭЛТ** (2025.06.14):
   - Осол гарсан огноо, цаг: 2025.06.14 09:48
   - Осол гарсан газар: Хан-Уул дүүрэг, 3-р хороо, Дунд голын зам, Нэткапитал финтек ббсб
   - Жолоочийн мэдээл: Ганхуяг Төгөлдөр (Toyota Crown, 14-91 УКС), Балдан Дашхүү (Toyota Harrier, 6338 УНЭ)
   - Зөрчсөн дүрмүүд: 1.3, 10.4

**ШИНЭ ЖОЛООЧИЙН МЭДЭЭЛЭЛ** (2025.06.14):
   - Жолоочийн нэр: Ганхуяг Төгөлдөр, Балдан Дашхүү
   - Регистрийн дугаар: Шу01301911, Рю79092216
   - Боловсрол: Дээд (Эм зүйч), Бүрэн дунд (жолооч)
   - Жолоочийн үнэмлэхний дугаар: 1534730, 212393
   - Жолооч болсон он: 2023, 2002
   - Хаяг: БЗД 13-р хороо 127-3-45 тоот, ХУД 2-р хороо 20-71 тоот
   - Утасны дугаар: 88828215, 91914954

**ШИНЭ ОСЛЫН СХЕМ** (2025.06.14):
   - Бүдүүвчийн гарчиг: "ОСОЛ, ХЭРЭГ ГАРСАН ГАЗАР ХИЙСЭН ХЭМЖИЛТИЙН БҮДҮҮВЧ"
   - Тээврийн хэрэгслүүд: Toyota Crown 1991, Toyota Harrier 6838
   - Уулзварын төрөл: Дөрвөн тал руу үргэлжлэх замуудтай

**ЧУУЛГА: Эдгээр нь өөр өөр ослуудын мэдээлэл тул тэдгээрийг ялгаж таних хэрэгтэй. Хэрэв ижил төрлийн бичиг баримт байвал тэдгээрийг нэгтгэж, өөр өөр ослуудын мэдээллийг тус тусад нь ялгаж таних.**

**ОСЛЫН ЖАГСААЛТ:**
1. **2025.02.19** - С. Баярзул, Mercedes-Benz 62-24 UEN (Хан-Уул дүүрэг, 20-р хороо)
2. **2025.05.27** - Дунай Тэрбиш, Toyota Land Cruiser-300, 61-18 УНМ (Хан-Уул дүүрэг, 05-р хороо)
3. **2025.06.14** - Ганхуяг Төгөлдөр, Toyota Crown, 14-91 УКС (Хан-Уул дүүрэг, 2-р хороо)
4. **2024.12.09** - Хорлоогийн Чулуунхүү, Toyota Prius, 38-54 УНУ (Сүхбаатар дүүрэг, 1-р хороо)
5. **2025.05.08** - Тайкун ХХК, Lexus RX400h, 57-71 УАХ (Төв аймаг, Сэргэлэн сум)

**ШИНЭ БИЧИГ БАРИМТУУД (2024.12.09):**

**ЭРХ БҮХИЙ АЛБАН ТУШААЛТНЫ ТЭМДЭГЛЭЛ:**
- Баримтын дугаар: 2869
- Осол гарсан огноо: 2024.12.09 14:39
- Осол гарсан газар: Сүхбаатар дүүрэг, 1-р хороо, 23-р байрны хойд талын зам
- Тээврийн хэрэгслүүд: Toyota Prius (38-54 УНУ), Toyota Land Cruiser (97-78 УАН)
- Жолоочийн нэр: Хорлоогийн Чулуунхүү, Гомбодоржийн Гантөмөр, Нацагдоржийн Ариунжаргал

**ЭРХ БҮХИЙ АЛБАН ТУШААЛТНЫ МАГАДЛАГАА:**
- Хэрэг бүртгэлийн дугаар: СО-2869
- Зөрчсөн дүрмүүд: 6.Тээврийн хэрэгслээр зорчигчийн үүрэг
- Дүгнэлт: Хорлоогийн Чулуунхүү замын дүрэм зөрчсөн

**ШИНЭ БИЧИГ БАРИМТУУД (2025.05.08):**

**ЗАМ ТЭЭВРИЙН ОСОЛ ДЭЭР ТОГТООСОН АКТ:**
- Баримтын дугаар: ЦБҮАЖ №207.71
- Осол гарсан огноо: 2025.05.08 18:05
- Осол гарсан газар: Төв аймаг, Сэргэлэн сум, Чингис Хаан нисэх буудлын орчим
- Тээврийн хэрэгсэл: Lexus RX400h, 57-71 УАХ
- Эзэмшигч: Тайкун ХХК
- Хурд: 25-30 км/цаг
- Эвдрэлийн тодорхойлолт: Урд гупер, зүүн урд их гэрэл, кузов, крыло, таван боолт

**ШИНЭ БИЧИГ БАРИМТУУД (2025.03.17):**

**ОСЛЫН ХЭМЖИЛТИЙН БҮДҮҮВЧ:**
- ГМ-ийн дугаар: 1100006
- Осол гарсан огноо: 2025.03.17 21:00
- Үзлэг хийсэн цаг: 21:30
- Осол гарсан газар: Хаалга 31 1км
- Тээврийн хэрэгсэл: Toyota Land Cruiser, 1818 УНХ
- Жолоочийн нэр: Б. Арлуупат

**ШИНЭ БИЧИГ БАРИМТУУД (2024.10.05):**

**ЭРХ БҮХИЙ АЛБАН ТУШААЛТНЫ ТЭМДЭГЛЭЛ:**
- Осол гарсан огноо: 2024.10.05 03:03
- Осол гарсан газар: Дорнод аймаг, Хэрлэн сум, 5-р баг, Доктайм хойд талын зам
- Албан тушаалтан: Б.Үнэнбат (цагдаагийн дэслэгч)
- Оролцогч: Обогоньватер
- Координатууд: 48.0171200, 114.46.35140

**ШИНЭ БИЧИГ БАРИМТУУД (2024.08.10):**

**ЭРХ БҮХИЙ АЛБАН ТУШААЛТНЫ ТЭМДЭГЛЭЛ:**
- Баримтын дугаар: 3X5-21
- Осол гарсан огноо: 2024.08.10
- Осол гарсан газар: Төв аймаг, Аргалант сум, 2-р баг
- Тээврийн хэрэгсэл: Lexus-250, 27-98 УЕН
- Жолоочийн нэр: П.Даваамаа

**ШИНЭ БИЧИГ БАРИМТУУД (2024.10.05):**

**ГЭРЭЛ ЗУРГИЙН ҮЗҮҮЛЭЛТ:**
- Баримтын төрөл: Гэрэл зургийн үзүүлэлт
- Осол гарсан огноо: 2024.10.05
- Осол гарсан газар: Дорнод аймаг, Хэрлэн сум, 5-р баг
- Холбогдсон тээврийн хэрэгсэл: HANVAN, 57-29УКУ
- Ослын төрөл: Тээврийн хэрэгсэл онхолдсон
- Гэрэл зурагчин: Б.Намуун (Криминалистикийн шинжээч)

**ШИНЭ БИЧИГ БАРИМТУУД (2024.10.05):**

**ОСЛЫН ГЭРЭЛ ЗУРГИЙН БАРИМТ:**
- Баримтын төрөл: Ослын гэрэл зургийн баримт
- Зургийн агуулга: Эвдэрсэн тээврийн хэрэгсэл, ослын газар, гэмтлийн хэмжээ
- Зургийн тоо: 4 зураг (№4, №5, №6, №7)
- Тайлбарууд: Автомашины ар хэсэг, зам, урд тал, ойр орчим
- Гэрэл зурагчин: Б.Намуун (Криминалистикийн шинжээч, Цагдаагийн ахлах дэслэгч)
- Онцлог: Шөнийн цагаар авсан, харанхуй, гэмтэлтэй тээврийн хэрэгсэл

**ШИНЭ БИЧИГ БАРИМТУУД (2025.07.02):**

**ЭРХ БҮХИЙ АЛБАН ТУШААЛТНЫ МАГАДЛАГАА:**
- Баримтын дугаар: ЗХБ-51
- Огноо: 2025.07.02
- Газрын байршил: Улаанбаатар хот
- Осол гарсан огноо: 2025.06.21 21:09
- Осол гарсан газар: Сонгинохайрхан дүүрэг, 23-р хороо, Содон хорооллын хойд зам
- Тээврийн хэрэгсэл 1: Lexus HS-250h, 51-54УБХ, жолооч Ж.Зандаасүрэн
- Тээврийн хэрэгсэл 2: T.Prius, 01-78УАО, жолооч Д.Энхтайван
- Зөрчсөн дүрэм: 12.3 (хурдыг хасах, зогсох)
- Албан тушаалтан: Н.Анхбаяр (Цагдаагийн дэд ахлагч)

**ШИНЭ БИЧИГ БАРИМТУУД (2024.07.18):**

**ЭРХ БҮХИЙ АЛБАН ТУШААЛТНЫ МАГАДЛАГАА:**
- Баримтын дугаар: ЗХБ-51
- Огноо: 2024.07.18
- Газрын байршил: Улаанбаатар хот
- Осол гарсан огноо: 2024.07.10 12:43
- Осол гарсан газар: Сүхбаатар дүүрэг, 5-р хороо, Золо зочид буудлын урд зам
- Тээврийн хэрэгсэл 1: Geely Monjaro, 59-93 УАУ, жолооч Т.Маралхүү
- Тээврийн хэрэгсэл 2: T.Crown, 59-22 УНУ, жолооч Э.Хүрэлболд
- Зөрчсөн дүрэм: 10.9 (уулзвараас бусад газарт эргэх)
- Албан тушаалтан: Б.Нандинцэцэг (Цагдаагийн ахмад)

**ШИНЭ БИЧИГ БАРИМТУУД (2025.06.11):**

**ЭРХ БҮХИЙ АЛБАН ТУШААЛТНЫ МАГАДЛАГАА:**
- Баримтын дугаар: №06
- Огноо: 2025.06.11
- Газрын байршил: Зуунмод сум
- Осол гарсан огноо: 2025.05.30 23:30
- Осол гарсан газар: Төв аймаг, Сэргэлэн сум, 2-р баг, Хөндлөнгийн давааны төв зам
- Тээврийн хэрэгсэл: Harrier, 51-71 УБҮ, жолооч Ш.Гантулга
- Зөрчсөн дүрмүүд: 1.3 (аюул, хохирол учруулахгүй), 18.3 (нүд гялбан, ослын дохионы гэрэл)
- Албан тушаалтан: Г.Гоцбаяр (Цагдаагийн дэслэгч)

**ШИНЭ БИЧИГ БАРИМТУУД (2025.07.02):**

**МАГАДЛАГАА (Assessment):**
- Баримтын төрөл: Магадлагаа
- Гарчиг: "2. Магадлагаа:"
- Шинжилгээний үр дүн: Ж.Зандаасүрэн - 12.3 дүрэм зөрчсөн, Д.Энхтайван - дүрэм зөрчөөгүй
- Зөрчсөн дүрэм: 12.3 (хурдыг хасах, зогсох)
- Танилцуулсан: Холбогдогч Ж.Зандаасүрэн, Хохирогч Д.Энхтайван
- Тамга: СОНГИНОХАЙРХАН ДҮҮРГИЙН ЦАГДААГИЙН ГАЗРЫН ЗАМЫН ЦАГДААГИЙН ХЭЛТЭС

**ШИНЭ БИЧИГ БАРИМТУУД (2024.07.18):**

**МАГАДЛАГАА (Assessment):**
- Баримтын төрөл: Магадлагаа
- Гарчиг: "2.1. шинжилгээний үр дүн, тогтоогдсон нөхцөл байдлын талаар:"
- Шинжилгээний үр дүн: Т.Маралхүү - 10.9 дүрэм зөрчсөн, Э.Хүрэлболд - дүрэм зөрчөөгүй
- Зөрчсөн дүрэм: 10.9 (уулзвараас бусад газарт эргэх)
- Танилцуулсан: Холбогдогч Т.Маралхүү, Хохирогч Э.Хүрэлболд
- Тамга: Сүхбаатар дүүргийн Замын цагдаагийн хэлтсийн 103 тоот өрөөнд

**ШИНЭ БИЧИГ БАРИМТУУД (2025.06.11):**

**МАГАДЛАГАА (Assessment):**
- Баримтын төрөл: Магадлагаа
- Гарчиг: "2. Магадалгаа: Шинжилгээний үр дүн, тогтоогдсон нөхцөл байдлын талаар:"
- Шинжилгээний үр дүн: Ш.Гантулга - 1.3, 18.3 дүрмүүд зөрчсөн
- Зөрчсөн дүрмүүд: 1.3 (аюул, хохирол учруулахгүй), 18.3 (нүд гялбан, ослын дохионы гэрэл)
- Танилцуулсан: Ш.Гантулга
- Тамга: Төв аймгийн Замын цагдаагийн тасгийн №01 тоот өрөөнд

**ШИНЭ БИЧИГ БАРИМТУУД (2024.07.12):**

**ЗАМ ТЭЭВРИЙН ОСЛЫН СХЕМ ЗУРАГ:**
- Баримтын төрөл: Зам тээврийн ослын схем зураг
- Баримтын дугаар: ЗХБ-21
- Огноо: 2024.07.12
- Газрын байршил: Улаанбаатар хот
- Осол гарсан огноо: 2024.02.12 12:45
- Осол гарсан газар: Сүхбаатар дүүрэг, дорослого урд замд уулзвар
- Тээврийн хэрэгсэл 1: Geely, 59-95YAY, жолооч Т.Мөнхчулуун
- Тээврийн хэрэгсэл 2: T.Crown, 54-22УНУ, жолооч Д.Энхболд
- Хэмжээсүүд: 9.20м, 2.0м, 7.20м, 10.20м
- Замын өргөн: 9.20 метр
- Замын хучилт: Асфальт, бетон, хөрсөн, хайрган
- Замын онцлог: Тэгш, хазгай, шулуун, өгсүүр, уруу, огцом эргэлт
- Цаг агаар: Цэлмэг, бүрхэг, бороотой, цастай, шуургатай, манантай
- Үзэгдэх орчин: Чөлөөтэй, хязгаарлагдмал, хангалтгүй
- Албан тушаалтан: Цагдаагийн ахлах дэслэгч

**ШИНЭ БИЧИГ БАРИМТУУД (2024.07.12):**

**ОСЛЫН ДҮГНЭЛТ:**
- Баримтын төрөл: Ослын дүгнэлт
- Гарчиг: "Ослын дүгнэлт"
- Замын хэсэг: Зохицуулдаг уулзвар, явган хүний гарц, төмөр замын гарам, гүүр
- Замын ангилал: Ердийн, хорооллын, тууш хурдны
- Замын хучилт: Асфальт, бетон, хөрсөн, хайрган
- Зорчих хэсгийн гадаргуу: Хуурай, нойтон, мөстэй, цастай, эвдрэлтэй, бохирдсон
- Замын онцлог: Тэгш, хазгай, шулуун, өгсүүр, уруу, огцом эргэлт
- Зорчих хэсгийн өргөн: 9.20 метр
- Үзэгдэх орчин: Чөлөөтэй, хязгаарлагдмал, хангалтгүй
- Цаг агаар: Цэлмэг, бүрхэг, бороотой, цастай, шуургатай, манантай
- Замын харъяалал: Суурингийн дотор, суурингийн гадна
- Хөдөлгөөний чиглэл: Эсрэг, нэг чигийн хөдөлгөөнтэй
- Замын байгууламж: Хашлагатай, хашлагагүй, хайстай, хайсгүй
- Хөндлөнгийн гэрч: Т.Мөнхчулуун, Д.Энхболд

**ШИНЭ БИЧИГ БАРИМТУУД (2025.03.28):**

**ТОДОРХОЙЛОЛТ (Ослын дүгнэлт):**
- Баримтын төрөл: Тодорхойлолт (Ослын дүгнэлт)
- Огноо: 2025.03.28
- Осол гарсан огноо: 2025.03.17 22:00
- Осол гарсан газар: Өмнөговь аймаг, Цогтцэций сумаас Даланзадгад сумын чиглэл, 7-р км
- Жолоочийн мэдээлэл: Цогт Ариунбат, Toyota Land Cruiser-J300 ZX, 1818 УНХ
- Ослын шалтгаан: Адуу мөргөхөөс зайлсхийж, шороон шуудуу мөргөсөн
- Зөрчсөн дүрмүүд: 3.6
- Согтууруулах ундаа: Хэрэглээгүй
- Албан тушаалтан: М.ТҮМЭНДЭЛГЭР (Цагдаагийн дэслэгч), Т.ТҮМЭНЖАРГАЛ (Цагдаагийн хошууч)
- Зорилго: Даатгалаар шийдвэрлүүлэх тул цагдаагийн шалгалтаас чөлөөлөгдсөн

**ШИНЭ БИЧИГ БАРИМТУУД (2024.10.05):**

**ТОДОРХОЙЛОЛТ (Ослын дүгнэлт):**
- Баримтын төрөл: Тодорхойлолт (Ослын дүгнэлт)
- Огноо: 2024.10.05
- Осол гарсан огноо: 2024.10.04 20:12
- Осол гарсан газар: Сэлэнгэ аймаг, Сүхбаатар сум, 5-р баг, Сүхбаатар самбар
- Жолоочийн мэдээлэл: Шийрэв Батхүү, Toyota Land Cruiser-LC300, 96-78 УЕН
- Ослын шалтгаан: Адуу гэнэт гарч ирэхэд тоормос гишгэсэн боловч мөргөж
- Зөрчсөн дүрмүүд: 12.3 (хурдыг хасах, зогсох)
- Согтууруулах ундаа: Хэрэглээгүй (0.00%)
- Албан тушаалтан: Ж.НЯМДАВАА (Цагдаагийн ахмад), Б.БУЛГАНТАМИР (Цагдаагийн ахмад)
- Зорилго: Даатгалаар шийдвэрлүүлэх

**ШИНЭ БИЧИГ БАРИМТУУД (2024.10.21):**

**ТОДОРХОЙЛОЛТ (Ослын дүгнэлт):**
- Баримтын төрөл: Тодорхойлолт (Ослын дүгнэлт)
- Огноо: 2024.10.21
- Осол гарсан огноо: 2024.10.06 03:00
- Осол гарсан газар: Дорнод аймаг, Хэрлэн сум, 5-р баг, Дэхт хорооллын хойд зам
- Жолоочийн мэдээлэл: Тэрбиш Отгонбаатар, Hanvan G7, 57-29 УКУ
- Ослын шалтгаан: Замын хөдөлгөөний дүрмийн 1.3 заалтыг зөрчиж, тээврийн хэрэгсэл онхолдсон
- Зөрчсөн дүрмүүд: 1.3 (аюул, хохирол учруулахгүй)
- Согтууруулах ундаа: Хэрэглээгүй
- Албан тушаалтан: Б.ҮНЭНБАТ (Цагдаагийн дэслэгч), Х.БАТСАЙХАН (Цагдаагийн хошууч)
- Зорилго: Даатгалаар шийдвэрлүүлэх

**ШИНЭ БИЧИГ БАРИМТУУД (2023.03.02):**

**ТОДОРХОЙЛОЛТ (Ослын дүгнэлт):**
- Баримтын төрөл: Тодорхойлолт (Ослын дүгнэлт)
- Огноо: 2023.03.02
- Осол гарсан огноо: 2023.02.28
- Осол гарсан газар: Дорноговь аймаг, Иххэт сум, 2-р баг, Хатуу шар
- Жолоочийн мэдээлэл: Батсүх Баярбат, Toyota Prado-150, 4727УЕА
- Ослын шалтгаан: Хөдөө газарт замын хөдөлгөөнд оролцож байхдаа осолдсон
- Зөрчсөн дүрмүүд: 12.3 (хурдыг хасах, зогсох)
- Согтууруулах ундаа: Хэрэглээгүй (0.00%)
- Албан тушаалтан: Л.ЧИНЗОРИГ (Цагдаагийн дэслэгч)
- Зорилго: Мандал даатгалд тодорхойлолт гаргах

**ШИНЭ БИЧИГ БАРИМТУУД (2025.02.06):**

**ТОДОРХОЙЛОЛТ (Ослын дүгнэлт):**
- Баримтын төрөл: Тодорхойлолт (Ослын дүгнэлт)
- Огноо: 2025.02.06
- Осол гарсан газар: Сэлэнгэ аймаг, Баянгол сум, Гонир 3-р баг, Бороогоулд салдаг
- Жолоочийн мэдээлэл: Гансүх Төмөртөр, Toyota Crown, 38-03УБМ
- Хохирогч: Хуан Юубас, Great Wall CC1030, 91-35УЕМ
- Ослын шалтгаан: Арын дугуй гулгаж мөргөсөн
- Зөрчсөн дүрмүүд: 12.3 (хурдыг хасах, зогсох)
- Согтууруулах ундаа: Хэрэглээгүй
- Албан тушаалтан: Д.БАЯРСАЙХАН (Цагдаагийн дэслэгч)
- Зорилго: Мандал даатгал ХХК-д тодорхойлолт гаргах

**ШИНЭ БИЧИГ БАРИМТУУД (2024.10.18):**

**ТОДОРХОЙЛОЛТ (Ослын дүгнэлт):**
- Баримтын төрөл: Тодорхойлолт (Ослын дүгнэлт)
- Огноо: 2024.10.18
- Осол гарсан огноо: 2024.10.13
- Осол гарсан газар: Булган аймаг, Хишиг-Өндөр сум, Мааньт 5-р баг, Ерөнхий боловсролын сургуулийн баруун урд
- Жолоочийн мэдээлэл: Норов Ган-Очир, Ланд-200, 2220 УНР
- Ослын шалтгаан: Овоолгоотой шороо мөргөж машинаа эвдэлсэн
- Зөрчсөн дүрмүүд: 12.2 (харанхуй үед хурд)
- Согтууруулах ундаа: Хэрэглээгүй
- Албан тушаалтан: Д.ӨЛЗИЙДАЛАЙ (Цагдаагийн ахмад)
- Зорилго: Мандал ХХК-нд тодорхойлолт гаргах

**ШИНЭ БИЧИГ БАРИМТУУД (2015.04.16):**

**ЭРХ БҮХИЙ АЛБАН ТУШААЛТНЫ ТЭМДЭГЛЭЛ:**
- Баримтын төрөл: Эрх бүхий албан тушаалтны тэмдэглэл
- Огноо: 2015.04.16
- Газрын байршил: Улаанбаатар хот
- Баримтын дугаар: ЗХБ-21
- Гарчиг: "Зам тээврийн ослын газарт үзлэг хийсэн тухай"
- Албан тушаалтан: Г.Алтангэрэл
- Оролцогч: Эг оргай Хсмеск
- Тээврийн хэрэгслүүд: L4500 (0105 УАУ), ANWO (7099 ХЯВ)
- Хэмжээсүүд: 90, 280, 190, 629, 1128
- Тамга: Сонгинохайрхан дүүргийн замын цагдаагийн хэлтэс

**ШИНЭ БИЧИГ БАРИМТУУД (2015.04.16):**

**ХӨНДЛӨНГИЙН ГЭРЧ:**
- Баримтын төрөл: Хөндлөнгийн гэрч
- Гарчиг: "ХӨНДЛӨНГИЙН ГЭРЧ:"
- Үзлэгийн явц: Дууны, дүрсний, дуу-дүрсний бичлэг, эрэл зураг, гар зураглал
- Албан тушаалтан: Г.Алтангэрэл
- Оролцогч: Ш. Батсайхан
- Тамга: Сонгинохайрхан дүүргийн замын цагдаагийн хэлтэс

**ШИНЭ БИЧИГ БАРИМТУУД (2015.04.16):**

**ЭТО (даатгалын тохиолдол)-ын тодорхойлолт:**
- Баримтын төрөл: ЭТО (даатгалын тохиолдол)-ын тодорхойлолт
- Гарчиг: "ЭТО (даатгалын тохиолдол)-ын тодорхойлолт"
- Осол гарсан огноо: Осол гарсан огноо
- Үзлэг хийсэн огноо: Үзлэг хийсэн огноо
- Осол гарсан Хот, аймаг: Осол гарсан Хот, аймаг
- Сум, дүүрэг: Сум, дүүрэг
- Замын байршил: Замын байршил
- Байршил дэлгэрэнгүй: Байршил дэлгэрэнгүй
- Зөрчигдсөн дүрмийн заалт: Зөрчигдсөн дүрмийн заалт
- Гомдол, мэдээлэл: Гомдол, мэдээлэл
- Осолд холбогдогч: Осолд холбогдогч
- Жолоодох эрх үнэмлэх: Жолоодох эрх үнэмлэх
- Зөрчлийн шийдвэрлэлт: Зөрчлийн шийдвэрлэлт
- Тээврийн хэрэгсэл: Тээврийн хэрэгсэл
- Нэмэлт тайлбар: Нэмэлт тайлбар

**ШИНЭ БИЧИГ БАРИМТУУД (2024.10.14):**

**ЭТО (даатгалын тохиолдол)-ын тодорхойлолт:**
- Баримтын төрөл: ЭТО (даатгалын тохиолдол)-ын тодорхойлолт
- Гарчиг: "ЭТО (даатгалын тохиолдол)-ын тодорхойлолт"
- Осол гарсан огноо: 2024-10-14 13:10
- Үзлэг хийсэн огноо: 2024-10-14 13:28
- Осол гарсан Хот, аймаг: Улаанбаатар
- Сум, дүүрэг: Баянзүрх дүүрэг
- Замын байршил: 115 - Натур худалдааны төвийн баруун хойд уулзвар
- Байршил дэлгэрэнгүй: НАТУР ЗАМ
- Зөрчигдсөн дүрмийн заалт: 11.14-11.14. Жолооч нь урдаа яваа тээврийн хэрэгсэл хурдаа хасах буюу зогсоход түүнийг мөргөхгүй, хажуу дахь тээврийн хэрэгслийг шүргэхгүй байх хэмжээний хоорондын болон хажуугийн зайг хөдөлгөөний хурднаас хамааруулан сонгож явна.
- Гомдол, мэдээлэл: 1100006240030237, 6-р хороо, 25-р баг / Ганга 11-р чиглэл, 115-3-50м Натур замаас, Хард Рок төв, зүүн өмнөд зам, Mitsubishi Fuso, 4602УБН, Green Factory ХХК, хорхой овогтой пүрэвсүрэн, 081010117, 89906565, хувийн эзэмшлийн Touareg, 9493УБУ, жаргал овогтой галням, 99069719, CHR86062532, 6-р хороо, 15-р баг, 1-13, мөргөлдсөн, d-13:10-13:28, 0-13:00
- Осолд холбогдогч: oa81010117, хорхой, Монгол, 1035694, пүрэвсүрэн, үгүй
- Зөрчлийн шийдвэрлэлт: (хоосон талбарууд)
- Нэмэлт тайлбар: / Бодь даатгал-АЖД ТХД/

**ШИНЭ БИЧИГ БАРИМТУУД (2024.10.20):**

**ЭТО (даатгалын тохиолдол)-ын тодорхойлолт:**
- Баримтын төрөл: ЭТО (даатгалын тохиолдол)-ын тодорхойлолт
- Гарчиг: "ЭТО (даатгалын тохиолдол)-ын тодорхойлолт"
- Осол гарсан огноо: 2024-10-20 16:00
- Үзлэг хийсэн огноо: 2024-10-20 16:30
- Осол гарсан Хот, аймаг: Улаанбаатар
- Сум, дүүрэг: Баянгол дүүрэг
- Замын байршил: 355 - Хорооллын эцсийн уулзвар
- Байршил дэлгэрэнгүй: бгд-ийн 9-р хороо / 355-пост/ хорооллын эцсийн сот-н байрны гадаа замд
- Зөрчигдсөн дүрмийн заалт: Эсрэг хөдөлгөөнТэй хоёр эгнээгээр зорчдог замд гүйцэж түрүүлэх буюу саадыг тойрон гарахаас бусад тохиолдолд эсрэг урсгал сөрөхийг хориглоно.
- Гомдол, мэдээлэл: 1121006240010088, 1100006240031354, t.land cruiser 300, 09-19 уек, t.sai, 98-30 укс, ариунжаргал овогтой энх-амгалан, болдбаатар овогтой батзориг, зам тээврийн осол гарсан
- Осолд холбогдогч: 86072711, ариунжаргал, Монгол, энх-амгалан, үгүй
- Зөрчлийн шийдвэрлэлт: (хоосон талбарууд)
- Нэмэлт тайлбар: Жолоочийн хариуцлагын даатгал, тээврийн хэрэгслийн албан журмын даатгал

**ШИНЭ БИЧИГ БАРИМТУУД (2025.04.05):**

**ШИЙТГЭЛИЙН ХУУДАС (маягт 2):**
- Баримтын төрөл: ШИЙТГЭЛИЙН ХУУДАС (маягт 2)
- Гарчиг: "ШИЙТГЭЛИЙН ХУУДАС (маягт 2)"
- Баримтын дугаар: № 1069052
- Огноо: 2025 оны 04 сарын 05 өдөр
- Дэд гарчиг: ХЯЛБАРШУУЛСАН ЖУРМААР ШИЙДВЭРЛЭХ ЗОРЧИЛД ШИЙТГЭЛ ОНОГДУУЛАХ ТУХАЙ
- Оногдуулсан шийтгэл: 100,000 төгрөг
- Төрийн сангийн данс: 00100000982
- Холбогдогч: (хоосон талбарууд)
- Зөрчил: (хоосон талбарууд)
- Шийдвэр гаргасан: (хоосон талбарууд)
- Танилцсан: 2025 оны 04 сарын 05 өдөр

**ШИНЭ БИЧИГ БАРИМТУУД (2024.10.20):**

**ШИЙТГЭЛИЙН ХУУДАС (маягт 2):**
- Баримтын төрөл: ШИЙТГЭЛИЙН ХУУДАС (маягт 2)
- Гарчиг: "ШИЙТГЭЛИЙН ХУУДАС (маягт 2)"
- Баримтын дугаар: № 0771371
- Огноо: 2024 оны 10 сарын 20 өдөр
- Дэд гарчиг: ХЯЛБАРШУУЛСАН ЖУРМААР ШИЙДВЭРЛЭХ ЗӨРЧИЛД ШИЙТГЭЛ ОНОГДУУЛАХ ТУХАЙ
- Осол гарсан огноо: 2024.10.06
- Осол гарсан газар: Хэрлэн сумын 5-р баг
- Холбогдогч: Т.Отгонбаатар, 87070577, УБ хот Уан Уул дүүрэн 11-р хороо
- Тээврийн хэрэгсэл: Нолиал G7, 57-29 УКУ
- Зөрчсөн дүрэм: 14.7.51, хөдөлгөөний аюулгүй байдлын журам зөрчсөн
- Оногдуулсан шийтгэл: 100,000.00 төгрөг
- Төрийн сангийн данс: 100071400952
- Төлбөрийн хугацаа: 15 хоног
- Эрх бүхий албан тушаалтан: Б.Үнэнбат
- Танилцсан: Т.Отгонбостор

**ШИНЭ БИЧИГ БАРИМТУУД (2024.10.20):**

**ШИЙТГЭЛИЙН ХУУДАС (маягт 2):**
- Баримтын төрөл: ШИЙТГЭЛИЙН ХУУДАС (маягт 2)
- Гарчиг: "ШИЙТГЭЛИЙН ХУУДАС (маягт 2)"
- Баримтын дугаар: № 0925173
- Огноо: 2024 оны 10 сарын 20 өдөр
- Дэд гарчиг: ХЯЛБАРШУУЛСАН ЖУРМААР ШИЙДВЭРЛЭХ ЗӨРЧИЛД ШИЙТГЭЛ ОНОГДУУЛАХ ТУХАЙ
- Оногдуулсан шийтгэл: 2000 төгрөг
- Холбогдогч: (хоосон талбарууд)
- Зөрчил: (хоосон талбарууд)
- Тамга: САНХҮҮ-1
- Шийдвэр гаргасан: (хоосон талбарууд)
- Танилцсан: (хоосон талбарууд)

**ШИНЭ БИЧИГ БАРИМТУУД (2015.04.16):**

**ЗТО (даатгалын тохиолдол)-ын тодорхойлолт:**
- Баримтын төрөл: ЗТО (даатгалын тохиолдол)-ын тодорхойлолт
- Гарчиг: "ЗТО (даатгалын тохиолдол)-ын тодорхойлолт"
- Осол гарсан огноо: Осол гарсан огноо
- Үзлэг хийсэн огноо: Үзлэг хийсэн огноо
- Осол гарсан Хот, аймаг: Осол гарсан Хот, аймаг
- Сум, дүүрэг: Сум, дүүрэг
- Замын байршил: Замын байршил
- Байршил дэлгэрэнгүй: Байршил дэлгэрэнгүй
- Зөрчигдсөн дүрмийн заалт: Зөрчигдсөн дүрмийн заалт
- Гомдол, мэдээлэл: Гомдол, мэдээлэл
- Осолд холбогдогч: Осолд холбогдогч
- Жолоодох эрх үнэмлэх: Жолоодох эрх үнэмлэх
- Зөрчлийн шийдвэрлэлт: Зөрчлийн шийдвэрлэлт
- Тээврийн хэрэгсэл: Тээврийн хэрэгсэл
- Нэмэлт тайлбар: Нэмэлт тайлбар

**ШИНЭ БИЧИГ БАРИМТУУД (2015.04.16):**

**ЗАМ ТЭЭВРИЙН ОСОЛ /ДААТГАЛЫН ТОХИОЛДОЛ/-ЫН ТОДОРХОЙЛОЛТ:**
- Баримтын төрөл: ЗАМ ТЭЭВРИЙН ОСОЛ /ДААТГАЛЫН ТОХИОЛДОЛ/-ЫН ТОДОРХОЙЛОЛТ
- Гарчиг: "ЗАМ ТЭЭВРИЙН ОСОЛ /ДААТГАЛЫН ТОХИОЛДОЛ/-ЫН ТОДОРХОЙЛОЛТ"
- Тодорхойлтын дугаар: Тодорхойлтын дугаар
- Төлөв: Төлөв
- Осол /даатгалын тохиолдол/ гарсан огноо: Осол /даатгалын тохиолдол/ гарсан огноо
- Осол /даатгалын тохиолдол/ гарсан цаг минут: Осол /даатгалын тохиолдол/ гарсан цаг минут
- Жолоочийн талаарх мэдээлэл: Жолоочийн талаарх мэдээлэл
- Улсын дугаар: Улсын дугаар
- Согтуурсан, мансуурсан эсэх: Согтуурсан, мансуурсан эсэх
- Зөрчлийг шийдвэрлэсэн алба хаагч: Зөрчлийг шийдвэрлэсэн алба хаагч
- Нэмэлт тайлбар: Нэмэлт тайлбар
- Бүртгэсэн хэрэглэгч: Бүртгэсэн хэрэглэгч
- Бүртгэсэн огноо: Бүртгэсэн огноо
- ТАЙЛБАР: ТАЙЛБАР
- Хэвлэсэн огноо: Хэвлэсэн огноо
- Хэвлэсэн ажилтан: Хэвлэсэн ажилтан

**ШИНЭ БИЧИГ БАРИМТУУД (2025.02.03):**

**ЗАМ ТЭЭВРИЙН ОСОЛ /ДААТГАЛЫН ТОХИОЛДОЛ/-ЫН ТОДОРХОЙЛОЛТ:**
- Баримтын төрөл: ЗАМ ТЭЭВРИЙН ОСОЛ /ДААТГАЛЫН ТОХИОЛДОЛ/-ЫН ТОДОРХОЙЛОЛТ
- Гарчиг: "ЗАМ ТЭЭВРИЙН ОСОЛ /ДААТГАЛЫН ТОХИОЛДОЛ/-ЫН ТОДОРХОЙЛОЛТ"
- Тодорхойлтын дугаар: 1121006250001344
- Төлөв: Баталгаажсан
- Осол /даатгалын тохиолдол/ гарсан огноо: 2025-02-03
- Осол /даатгалын тохиолдол/ гарсан цаг минут: 17:00:00
- Жолоочийн талаарх мэдээлэл: ганбаатар, чл67061578
- Улсын дугаар: (хоосон)
- Согтуурсан, мансуурсан эсэх: ????
- Зөрчлийг шийдвэрлэсэн алба хаагч: (хоосон)
- Нэмэлт тайлбар: 10.3 - 10.3. Жолооч гарцаар замд нийлэх, замаас гарахдаа уг замын дагуу яваа хөдөлгөөнд оролцогчдод зам тавьж өгнө. бгд-17/11-р чиглэл 317-6-500 / модны-2-н замд голомт банк / т.land-300 / 83-88 уан / автомашины жолооч нь хувийн эзэмшлийн d.hijet / 24-89 өво / болдбаатар овогтой ууганбаяр / бгд-ийн 19-р хороо 70-117 тоот, кю93021816, 88040579 / жолоочтой мөргөлдсөн это жч: т.land-300 маркийн жолооч болох 99119877 дугаар луу ярихад очиж чадахгүй гэв /акт / а/х ц.сэргэлэн д:17:57 γ:18:15 0:17:40
- Бүртгэсэн хэрэглэгч: (хоосон)
- Бүртгэсэн огноо: 2025-02-03
- ТАЙЛБАР: ТАЙЛБАР
- Хэвлэсэн огноо: Хэвлэсэн огноо
- Хэвлэсэн ажилтан: Хэвлэсэн ажилтан

**ШИНЭ БИЧИГ БАРИМТУУД (2024.10.20):**

**ЗАМ ТЭЭВРИЙН ОСОЛ /ДААТГАЛЫН ТОХИОЛДОЛ/-ЫН ТОДОРХОЙЛОЛТ:**
- Баримтын төрөл: ЗАМ ТЭЭВРИЙН ОСОЛ /ДААТГАЛЫН ТОХИОЛДОЛ/-ЫН ТОДОРХОЙЛОЛТ
- Гарчиг: "ЗАМ ТЭЭВРИЙН ОСОЛ /ДААТГАЛЫН ТОХИОЛДОЛ/-ЫН ТОДОРХОЙЛОЛТ"
- Тодорхойлтын дугаар: 1121006240010088
- Төлөв: Баталгаажсан
- Осол /даатгалын тохиолдол/ гарсан огноо: 2024-10-20 16:00
- Осол /даатгалын тохиолдол/ гарсан цаг минут: 10/29/2024 10:27:40
- Жолоочийн талаарх мэдээлэл: ЭНХ-АМГАЛАН
- Улсын дугаар: (хоосон)
- Согтуурсан, мансуурсан эсэх: ҮГҮЙ
- Зөрчлийг шийдвэрлэсэн алба хаагч: (хоосон)
- Нэмэлт тайлбар: 2024-10-22, 1121006240010088, 1100006240031354, бгд-ийн 9-р хороо / 355-пост/ хорооллын эцсийн сот-н байрны гадаа замд, Улаанбаатар, Баянгол дүүрэг, 355-Хорооллын эцсийн уулзвар, t. land cruiser 300, t.sai, ариунжаргал овогтой энх-амгалан, болдбаатар овогтой батзориг, зам тээврийн осол гарсан, Эсрэг хөдөлгөөнТэй хоёр эгнээгээр зорчдог замд гүйцэж түрүүлэх буюу саадыг тойрон гарахаас бусад тохиолдолд эсрэг урсгал сөрөхийг хориглоно.
- Бүртгэсэн хэрэглэгч: (хоосон)
- Бүртгэсэн огноо: (хоосон)
- ТАЙЛБАР: ТАЙЛБАР
- Хэвлэсэн огноо: Хэвлэсэн огноо
- Хэвлэсэн ажилтан: Хэвлэсэн ажилтан

Эдгээр мэдээллийг JSON форматтай болгож, дараах талбаруудаар бүтэцжүүлнэ үү:

{
  "documentType": "бичиг баримтын төрөл",
  "isValid": true,
  "photoType": "бичиг баримтын нэр",
  "message": "амжилттай танигдлаа",
  
}

Хэрэв талбар хоосон бол null гэж бичнэ үү. Зөвхөн JSON форматтай хариулна уу.`,
          },
          {
            role: "user",
            content: [
              {
                type: "text",
                text: "Энэ цагдааны ослын бичиг баримтыг таниж, дээрх талбаруудаар мэдээллийг гаргана уу. Хэрэв талбар хоосон бол null гэж бичнэ үү. Зургийн чанар муу байж болох тул боломжтой хэмжээгээр мэдээллийг танихыг хичээ. Хэрэв тодорхой бичигдээгүй бол null гэж бичнэ үү.",
              },
              { type: "image_url", image_url: { url: base64Url } },
            ],
          },
        ],
        max_tokens: 2000, // 7000-аас 2000 болгож бууруулсан
        temperature: 0.1,
        stream: false, // Streaming идэвхгүй болгох
      };

      // Timeout controller - хурдны сайжруулалт
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000); // 30 секундаас 15 секунд болгож бууруулсан

      try {
        const response = await fetch(
          "https://api.openai.com/v1/chat/completions",
          {
            method: "POST",
            headers: {
              Authorization: "Bearer " + process.env.NEXT_PUBLIC_OPENAI_API_KEY,
              "Content-Type": "application/json",
            },
            body: JSON.stringify(apiRequestBody),
            signal: controller.signal,
          }
        );

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.choices && data.choices[0]) {
          let content = data.choices[0].message.content.trim();

          // JSON parse
          if (content.startsWith("```json")) {
            content = content.replace("```json", "").replace("```", "").trim();
          } else if (content.startsWith("```")) {
            content = content.replace(/```/g, "").trim();
          }

          try {
            const parsedData = JSON.parse(content);

            // Cache-д хадгалах
            setProcessedFiles((prev) =>
              new Map(prev).set(fileHash, parsedData)
            );

            return parsedData;
          } catch (error) {
            console.error("JSON parsing error:", error);
            const fallbackResponse: PolicePhotoValidation = {
              isValid: false,
              photoType: "Буруу зураг",
              message: "AI хариултыг уншихад алдаа гарлаа.",
            };

            // Cache-д хадгалах
            setProcessedFiles((prev) =>
              new Map(prev).set(fileHash, fallbackResponse)
            );

            return fallbackResponse;
          }
        } else {
          const errorResponse: PolicePhotoValidation = {
            isValid: false,
            photoType: "Буруу зураг",
            message: "AI хариулт ирсэнгүй.",
          };

          // Cache-д хадгалах
          setProcessedFiles((prev) =>
            new Map(prev).set(fileHash, errorResponse)
          );

          return errorResponse;
        }
      } catch (error) {
        clearTimeout(timeoutId);
        console.error("API error:", error);

        // Timeout error handling
        if (error instanceof Error && error.name === "AbortError") {
          const timeoutResponse: PolicePhotoValidation = {
            isValid: false,
            photoType: "Буруу зураг",
            message: "AI хариулалт удаж байна. Дахин оролдоно уу.",
          };

          // Cache-д хадгалах
          setProcessedFiles((prev) =>
            new Map(prev).set(fileHash, timeoutResponse)
          );

          return timeoutResponse;
        }

        const errorResponse: PolicePhotoValidation = {
          isValid: false,
          photoType: "Буруу зураг",
          message: "AI боловсруулалтад алдаа гарлаа.",
        };

        // Cache-д хадгалах
        setProcessedFiles((prev) => new Map(prev).set(fileHash, errorResponse));

        return errorResponse;
      }
    } catch (error) {
      console.error("Resize error:", error);
      const errorResponse: PolicePhotoValidation = {
        isValid: false,
        photoType: "Буруу зураг",
        message: "Зураг resize хийхэд алдаа гарлаа.",
      };
      return errorResponse;
    }
  };

  // Debounced file processing
  const debouncedProcessFiles = (files: File[]) => {
    if (debounceTimer) {
      clearTimeout(debounceTimer);
    }

    const timer = setTimeout(async () => {
      try {
        const results = await processEmergencyFilesInParallel(files);

        // Хэрэв мэдээлэл танигдсан бол form руу дамжуулна
        results.forEach(({ result }) => {
          if (result.isValid && result.extractedData && onDataExtracted) {
            onDataExtracted(result.extractedData);
          }
        });

        // Toast харуулах
        const validResults = results.filter((r) => r.result.isValid);
        const invalidResults = results.filter((r) => !r.result.isValid);

        if (validResults.length > 0) {
          setToast({
            message: `${validResults.length} файл амжилттай танигдлаа!`,
            isSuccess: true,
          });
        }

        if (invalidResults.length > 0) {
          setToast({
            message: `${invalidResults.length} файл танигдаагүй байна.`,
            isSuccess: false,
          });
        }
      } catch (error) {
        console.error("Processing error:", error);
        setToast({
          message: "Файл боловсруулалтад алдаа гарлаа.",
          isSuccess: false,
        });
      } finally {
        setIsProcessing(false);
      }
    }, 300); // 300ms debounce

    setDebounceTimer(timer);
  };

  // Parallel processing функц - хурдны сайжруулалт
  const processEmergencyFilesInParallel = async (files: File[]) => {
    // Batch processing - 3 файл хүртэл зэрэг боловсруулах
    const batchSize = 3;
    const results: { file: File; result: PolicePhotoValidation }[] = [];

    for (let i = 0; i < files.length; i += batchSize) {
      const batch = files.slice(i, i + batchSize);
      const batchPromises = batch.map(async (file) => {
        const result = await validateEmergencyDocument(file);
        return { file, result };
      });

      const batchResults = await Promise.all(batchPromises);
      results.push(...batchResults);

      // UI update хурдасгах
      setUploadedFiles((prev) =>
        prev.map((uploadedFile) => {
          const result = results.find((r) => r.file === uploadedFile.file);
          if (result) {
            return {
              ...uploadedFile,
              validation: result.result,
              isProcessing: false,
            };
          }
          return uploadedFile;
        })
      );
    }

    return results;
  };

  const handleEmergencyFileChange = async (
    e: React.ChangeEvent<HTMLInputElement>
  ) => {
    const files = Array.from(e.target.files || []);
    if (files.length === 0) return;

    // Хэрэв нэг зураг л оруулах бол эхний файлыг л авна
    const filesToProcess = multiple ? files : [files[0]];

    setIsProcessing(true);

    // Шинэ файлуудыг нэмэх
    const newUploadedFiles: UploadedFile[] = filesToProcess.map((file) => ({
      file,
      preview: URL.createObjectURL(file),
      validation: null,
      isProcessing: true,
    }));

    setUploadedFiles((prev) => [...prev, ...newUploadedFiles]);

    // Form руу дамжуулах
    if (onImageSelected) {
      onImageSelected(filesToProcess);
    }

    try {
      // Debounced processing ашиглах
      debouncedProcessFiles(filesToProcess);
    } catch (error) {
      console.error("Processing error:", error);
      setToast({
        message: "Файл боловсруулалтад алдаа гарлаа.",
        isSuccess: false,
      });
      setIsProcessing(false);
    }
  };

  const removeEmergencyFile = (index: number) => {
    setUploadedFiles((prev) => {
      const fileToRemove = prev[index];
      URL.revokeObjectURL(fileToRemove.preview);
      return prev.filter((_, i) => i !== index);
    });
  };

  const resetEmergencyForm = () => {
    if (uploadedFiles) {
      uploadedFiles.forEach((uploadedFile) => {
        URL.revokeObjectURL(uploadedFile.preview);
      });
    }
    setUploadedFiles([]);
    setToast(null);
  };

  return (
    <div className="mt-6  border-gray-200 rounded-lg overflow-hidden ">
      {/* Card Header */}

      {/* Card Body */}
      <div className="bg-white p-6 space-y-6">
        {/* Upload Area */}
        <div className="border-2 border-dashed border-blue-400 rounded-xl p-6 hover:border-blue-500 transition-colors">
          <label
            htmlFor="traffic-police-photo-upload"
            className="cursor-pointer flex flex-col items-center gap-3"
          >
            <div className="bg-blue-100 rounded-full p-3">
              <Upload className="h-6 w-6 text-blue-600" />
            </div>
            <div className="text-center">
              <span className="text-blue-700 font-medium text-lg">
                {multiple
                  ? "Цагдааны ослын бичиг баримтууд оруулна уу"
                  : "Цагдааны ослын бичиг баримт оруулна уу"}
              </span>
              <p className="text-sm text-gray-500 mt-1">
                {multiple
                  ? "(JPG, PNG, HEIC... - олон файл)"
                  : "(JPG, PNG, HEIC...)"}
              </p>
            </div>

            <input
              id="traffic-police-photo-upload"
              type="file"
              accept="image/*"
              multiple={multiple}
              className="hidden"
              onChange={handleEmergencyFileChange}
              disabled={isProcessing}
            />
          </label>
        </div>

        <FileUploadGrid
          uploadedFiles={uploadedFiles}
          onRemoveFile={removeEmergencyFile}
        />

        {/* Action Buttons */}
        {uploadedFiles?.length > 0 && (
          <ActionButtons
            onReset={resetEmergencyForm}
            onSubmit={() => document.getElementById("")?.click()}
            submitText="Нэмэх"
            showSubmit={true}
            showPlusIcon={true}
          />
        )}

        {toast && (
          <ShowAIToast message={toast.message} isSuccess={toast.isSuccess} />
        )}
      </div>
    </div>
  );
}
